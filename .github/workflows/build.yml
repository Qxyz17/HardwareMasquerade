name: Build Hardware Masquerade

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build Type'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - debug
      platform:
        description: 'Platform'
        required: true
        default: 'x64'
        type: choice
        options:
          - x64
          - x86

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Visual Studio Build Tools
        uses: microsoft/setup-msbuild@v2
      
      - name: Run CI build script
        shell: cmd
        run: |
          echo "Running CI build script..."
          build-ci.bat
        continue-on-error: false
      
      - name: List output files
        shell: pwsh
        run: |
          Write-Host "Output directory contents:" -ForegroundColor Green
          if (Test-Path "output") {
            Get-ChildItem -Path output | ForEach-Object {
              Write-Host "  - $($_.Name)" -ForegroundColor White
            }
          }
          
          Write-Host "`nDistribution directory contents:" -ForegroundColor Green
          if (Test-Path "dist") {
            Get-ChildItem -Path dist | ForEach-Object {
              $size = [math]::Round($_.Length / 1MB, 2)
              Write-Host "  - $($_.Name) ($size MB)" -ForegroundColor White
            }
          }
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: HardwareMasquerade-CI-${{ github.run_number }}-${{ github.event.inputs.platform }}
          path: |
            output/
            dist/
          if-no-files-found: warn
          retention-days: 30