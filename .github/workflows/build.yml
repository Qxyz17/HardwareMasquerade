name: Build Hardware Masquerade

# åªæ”¯æŒæ‰‹åŠ¨è§¦å‘
on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build Type'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - debug
      
      target_platform:
        description: 'Target Platform'
        required: true
        default: 'x64'
        type: choice
        options:
          - x64
          - x86
      
      include_driver:
        description: 'Include Kernel Driver'
        required: true
        default: true
        type: boolean
      
      build_gui:
        description: 'Build GUI Application'
        required: true
        default: true
        type: boolean
      
      create_zip:
        description: 'Create ZIP Package'
        required: true
        default: true
        type: boolean

env:
  CONFIGURATION: ${{ github.event.inputs.build_type }}
  PLATFORM: ${{ github.event.inputs.target_platform }}

jobs:
  build:
    name: Build (${{ github.event.inputs.build_type }}-${{ github.event.inputs.target_platform }})
    runs-on: windows-latest
    permissions:
      contents: read
      actions: write
      checks: write
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      # 2. è®¾ç½®ç‰ˆæœ¬å·
      - name: Set version
        id: version
        shell: pwsh
        run: |
          $date = Get-Date -Format "yyyyMMdd"
          $runNumber = "${{ github.run_number }}".PadLeft(4, '0')
          $version = "1.0.$runNumber-$date"
          echo "VERSION=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          echo "Building version: $version"
      
      # 3. æ˜¾ç¤ºæ„å»ºä¿¡æ¯
      - name: Show build info
        run: |
          echo "========================================"
          echo "Build Information"
          echo "========================================"
          echo "Triggered by: ${{ github.actor }}"
          echo "Build type: ${{ github.event.inputs.build_type }}"
          echo "Platform: ${{ github.event.inputs.target_platform }}"
          echo "Include driver: ${{ github.event.inputs.include_driver }}"
          echo "Build GUI: ${{ github.event.inputs.build_gui }}"
          echo "Create ZIP: ${{ github.event.inputs.create_zip }}"
          echo "Version: ${{ steps.version.outputs.VERSION }}"
          echo "========================================"
      
      # 4. è®¾ç½® Python
      - name: Setup Python
        if: ${{ github.event.inputs.build_gui == 'true' }}
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      # 5. å®‰è£… Python ä¾èµ–
      - name: Install Python dependencies
        if: ${{ github.event.inputs.build_gui == 'true' }}
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller psutil PyQt6
          pip freeze > python-dependencies.txt
      
      # 6. åˆ›å»ºè¾“å‡ºç›®å½•
      - name: Create output directories
        run: |
          New-Item -ItemType Directory -Force -Path output
          New-Item -ItemType Directory -Force -Path artifacts
          Write-Host "Output directories created" -ForegroundColor Green
      
      # 7. æŸ¥æ‰¾ Visual Studio å¹¶æ„å»º
      - name: Build with Visual Studio
        shell: cmd
        run: |
          @echo off
          echo Finding Visual Studio...
          
          REM æŸ¥æ‰¾ Visual Studio 2022
          set VS_PATH=
          for /f "usebackq tokens=*" %%i in (`"%ProgramFiles(x86)%\Microsoft Visual Studio\Installer\vswhere.exe" -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath`) do (
            set VS_PATH=%%i
          )
          
          if not defined VS_PATH (
            echo Visual Studio 2022 not found, trying VS 2019...
            for /f "usebackq tokens=*" %%i in (`"%ProgramFiles(x86)%\Microsoft Visual Studio\Installer\vswhere.exe" -version 16.0 -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath`) do (
              set VS_PATH=%%i
            )
          )
          
          if not defined VS_PATH (
            echo ERROR: Visual Studio not found!
            exit /b 1
          )
          
          echo Found Visual Studio at: %VS_PATH%
          
          REM åŠ è½½ Visual Studio ç¯å¢ƒ
          call "%VS_PATH%\VC\Auxiliary\Build\vcvars64.bat"
          if errorlevel 1 (
            echo Failed to load Visual Studio environment!
            exit /b 1
          )
          
          echo Visual Studio environment loaded successfully
          echo.
          
          REM æŸ¥æ‰¾ WDK
          set WDK_FOUND=0
          for /f "usebackq tokens=*" %%d in (`dir "C:\Program Files (x86)\Windows Kits\10\Include" /b /ad /o-n 2>nul`) do (
            if exist "C:\Program Files (x86)\Windows Kits\10\Include\%%d\km" (
              set WDK_VERSION=%%d
              set WDK_FOUND=1
              echo Found WDK version: %%d
              goto :found_wdk
            )
          )
          :found_wdk
          
          if "%WDK_FOUND%"=="0" (
            echo WDK not found, skipping driver compilation
          ) else (
            set WDK_INCLUDE=C:\Program Files (x86)\Windows Kits\10\Include\%WDK_VERSION%
          )
          
          echo.
          echo Starting compilation...
          echo ================================
          
          REM ç¼–è¯‘é©±åŠ¨ï¼ˆå¦‚æœå¯ç”¨ï¼‰
          if "${{ github.event.inputs.include_driver }}"=="true" (
            if not "%WDK_FOUND%"=="0" (
              echo.
              echo [1/4] Building kernel driver...
              
              cl.exe /nologo /O2 /MT /W4 /Gz ^
                /I"%WDK_INCLUDE%\km" ^
                /I"%WDK_INCLUDE%\um" ^
                /I"%WDK_INCLUDE%\shared" ^
                /I"common" ^
                /D_KERNEL_MODE /DDBG=1 /DUNICODE /D_UNICODE ^
                /Feoutput\HardwareSpoofer.sys ^
                driver\HardwareSpoofer.c ^
                /link /subsystem:native ^
                ntoskrnl.lib hal.lib
              
              if errorlevel 1 (
                echo âš ï¸  Driver build failed!
              ) else (
                echo âœ… Driver built successfully!
              )
              
              echo.
              echo [2/4] Building driver loader...
              
              cl.exe /nologo /O2 /W4 ^
                /I"common" ^
                /Feoutput\loader.exe ^
                driver_loader\loader.c ^
                /link advapi32.lib user32.lib
              
              if errorlevel 1 (
                echo âš ï¸  Loader build failed!
              ) else (
                echo âœ… Loader built successfully!
              )
              
              echo.
              echo [3/4] Building Windows service...
              
              cl.exe /nologo /O2 /W4 ^
                /I"common" ^
                /Feoutput\service.exe ^
                service\service.c ^
                /link advapi32.lib user32.lib
              
              if errorlevel 1 (
                echo âš ï¸  Service build failed!
              ) else (
                echo âœ… Service built successfully!
              )
            ) else (
              echo Skipping driver build (WDK not found)
            )
          ) else (
            echo Skipping driver build (disabled by user)
          )
          
          echo.
          echo [4/4] Building test program...
          
          REM åˆ›å»ºæµ‹è¯•ç¨‹åºç›®å½•
          if not exist test mkdir test
          
          REM åˆ›å»ºç®€å•çš„æµ‹è¯•ç¨‹åº
          echo #include ^<stdio.h^> > test\test.c
          echo #include ^<windows.h^> >> test\test.c
          echo. >> test\test.c
          echo int main() { >> test\test.c
          echo     printf("Hardware Masquerade Test Program\n"); >> test\test.c
          echo     printf("================================\n\n"); >> test\test.c
          echo     return 0; >> test\test.c
          echo } >> test\test.c
          
          cl.exe /nologo /O2 /W4 ^
            /Feoutput\test.exe ^
            test\test.c ^
            /link user32.lib
          
          if errorlevel 1 (
            echo âš ï¸  Test program build failed!
          ) else (
            echo âœ… Test program built successfully!
          )
          
          echo.
          echo ================================
          echo Compilation complete!
      
      # 8. æ„å»º GUIï¼ˆå¦‚æœå¯ç”¨ï¼‰
      - name: Build GUI Application
        if: ${{ github.event.inputs.build_gui == 'true' }}
        shell: pwsh
        run: |
          Write-Host "Building GUI application..." -ForegroundColor Yellow
          cd gui
          
          # æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨
          if (-not (Test-Path "main.py")) {
            Write-Host "GUI source not found, skipping..." -ForegroundColor Red
            cd ..
            return
          }
          
          # åˆ›å»ºç‰ˆæœ¬æ–‡ä»¶
          $version = "${{ steps.version.outputs.VERSION }}"
          @"
VERSION = '$version'
BUILD_DATE = '$(Get-Date -Format "yyyy-MM-dd HH:mm:ss")'
BUILD_PLATFORM = '${{ env.PLATFORM }}'
BUILD_TYPE = '${{ env.CONFIGURATION }}'
"@ | Out-File -FilePath version.py -Encoding utf8
          
          # ä½¿ç”¨ PyInstaller æ‰“åŒ…
          if (Get-Command pyinstaller -ErrorAction SilentlyContinue) {
            pyinstaller --onefile --windowed `
              --name "HardwareMasquerade" `
              --hidden-import PyQt6.sip `
              --hidden-import psutil `
              --noconfirm `
              main.py
            
            if ($LASTEXITCODE -eq 0 -and (Test-Path "dist\HardwareMasquerade.exe")) {
              Write-Host "âœ… GUI built successfully!" -ForegroundColor Green
              Copy-Item -Path "dist\HardwareMasquerade.exe" -Destination "..\output\" -Force
            } else {
              Write-Host "âš ï¸  GUI build failed!" -ForegroundColor Red
            }
          } else {
            Write-Host "PyInstaller not found, skipping GUI build" -ForegroundColor Yellow
          }
          
          cd ..
      
      # 9. åˆ—å‡ºè¾“å‡ºæ–‡ä»¶
      - name: List output files
        run: |
          Write-Host "`nOutput directory contents:" -ForegroundColor Cyan
          if (Test-Path "output") {
            Get-ChildItem -Path output | ForEach-Object {
              $size = [math]::Round($_.Length / 1KB, 2)
              Write-Host "  ğŸ“„ $($_.Name) ($size KB)" -ForegroundColor White
            }
          } else {
            Write-Host "  No output files found" -ForegroundColor Yellow
          }
      
      # 10. åˆ›å»º ZIP åŒ…ï¼ˆå¦‚æœå¯ç”¨ï¼‰
      - name: Create ZIP package
        if: ${{ github.event.inputs.create_zip == 'true' }}
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          $packageName = "HardwareMasquerade-$version-${{ env.PLATFORM }}"
          $packageDir = "artifacts\$packageName"
          
          New-Item -ItemType Directory -Force -Path $packageDir | Out-Null
          
          # å¤åˆ¶æ„å»ºæ–‡ä»¶
          if (Test-Path "output") {
            Copy-Item -Path "output\*" -Destination $packageDir -Force -ErrorAction SilentlyContinue
          }
          
          # åˆ›å»º README
          @"
Hardware Masquerade v$version
=============================

Build Information:
- Version: $version
- Platform: ${{ env.PLATFORM }}
- Build Type: ${{ env.CONFIGURATION }}
- Build Date: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC")
- Triggered by: ${{ github.actor }}

Files Included:
$(Get-ChildItem -Path $packageDir | ForEach-Object { "- $($_.Name)" })

How to use:
1. Extract all files to a folder
2. Run HardwareMasquerade.exe (if GUI was built)
3. For driver installation, use loader.exe

Note: This is a manual build from GitHub Actions.
"@ | Out-File -FilePath "$packageDir\README.txt" -Encoding utf8 -Force
          
          # åˆ›å»º ZIP åŒ…
          Write-Host "Creating ZIP package..." -ForegroundColor Yellow
          Compress-Archive -Path "$packageDir\*" -DestinationPath "artifacts\$packageName.zip" -Force
          
          Write-Host "âœ… ZIP package created: artifacts\$packageName.zip" -ForegroundColor Green
      
      # 11. ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: HardwareMasquerade-${{ steps.version.outputs.VERSION }}-${{ env.PLATFORM }}
          path: |
            output/
            artifacts/
            python-dependencies.txt
          if-no-files-found: warn
          retention-days: 30
      
      # 12. æ˜¾ç¤ºæ„å»ºæ‘˜è¦
      - name: Build summary
        if: always()
        run: |
          Write-Host "`n========================================" -ForegroundColor Cyan
          Write-Host "        Build Complete" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "ğŸ“¦ Version:     ${{ steps.version.outputs.VERSION }}" -ForegroundColor Green
          Write-Host "ğŸ–¥ï¸  Platform:    ${{ env.PLATFORM }}" -ForegroundColor Green
          Write-Host "ğŸ”§ Build Type:  ${{ env.CONFIGURATION }}" -ForegroundColor Green
          Write-Host "ğŸš€ Status:      ${{ job.status }}" -ForegroundColor Green
          Write-Host ""
          Write-Host "Download artifacts from the summary above â˜ï¸" -ForegroundColor Yellow
