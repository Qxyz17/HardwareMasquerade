name: Manual Build Hardware Masquerade

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build Type'
        required: true
        default: 'release'
        type: choice
        options:
          - debug
          - release
      
      target_platform:
        description: 'Target Platform'
        required: true
        default: 'x64'
        type: choice
        options:
          - x64
          - x86
      
      include_driver:
        description: 'Include Kernel Driver'
        required: true
        default: true
        type: boolean
      
      build_gui:
        description: 'Build GUI Application'
        required: true
        default: true
        type: boolean
      
      create_zip:
        description: 'Create ZIP Package'
        required: true
        default: true
        type: boolean

env:
  CONFIGURATION: ${{ github.event.inputs.build_type }}
  PLATFORM: ${{ github.event.inputs.target_platform }}

jobs:
  manual-build:
    name: Manual Build (${{ github.event.inputs.build_type }}-${{ github.event.inputs.target_platform }})
    runs-on: windows-latest
    
    steps:
      # 1. 检出代码
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      # 2. 设置版本号
      - name: Set version
        id: version
        shell: pwsh
        run: |
          $date = Get-Date -Format "yyyyMMdd"
          $runNumber = "${{ github.run_number }}".PadLeft(4, '0')
          $version = "1.0.$runNumber-$date"
          echo "VERSION=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          echo "Building version: $version"
      
      # 3. 安装 Visual Studio 构建工具
      - name: Setup Visual Studio 2022
        uses: microsoft/setup-msbuild@v2
        with:
          vs-version: '17.0'  # 对应 VS 2022
        continue-on-error: true
      
      # 4. 如果上面的步骤失败，尝试安装 VS 2019
      - name: Setup Visual Studio 2019 (fallback)
        if: failure()
        uses: microsoft/setup-msbuild@v2
        with:
          vs-version: '16.0'  # 对应 VS 2019
      
      # 5. 设置 Python
      - name: Setup Python
        if: ${{ github.event.inputs.build_gui == 'true' }}
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      # 6. 安装 Python 依赖
      - name: Install Python dependencies
        if: ${{ github.event.inputs.build_gui == 'true' }}
        run: |
          pip install --upgrade pip
          pip install pyinstaller psutil PyQt6
          pip freeze > python-dependencies.txt
      
      # 7. 创建输出目录
      - name: Create output directory
        run: |
          New-Item -ItemType Directory -Force -Path output
          New-Item -ItemType Directory -Force -Path artifacts
      
      # 8. 使用开发者命令提示符构建
      - name: Build all components
        shell: cmd
        run: |
          echo Building all components...
          
          REM 查找 Visual Studio
          set VS_PATH=
          for /f "usebackq tokens=*" %%i in (`"%ProgramFiles(x86)%\Microsoft Visual Studio\Installer\vswhere.exe" -latest -property installationPath`) do (
            set VS_PATH=%%i
          )
          
          if not defined VS_PATH (
            echo Visual Studio not found!
            exit /b 1
          )
          
          echo Found Visual Studio at: %VS_PATH%
          
          REM 加载 Visual Studio 环境
          call "%VS_PATH%\VC\Auxiliary\Build\vcvars64.bat"
          if errorlevel 1 (
            echo Failed to load Visual Studio environment!
            exit /b 1
          )
          
          REM 查找 WDK
          set WDK_FOUND=0
          for /f "usebackq tokens=*" %%d in (`dir "C:\Program Files (x86)\Windows Kits\10\Include" /b /ad /o-n`) do (
            if exist "C:\Program Files (x86)\Windows Kits\10\Include\%%d\km" (
              set WDK_VERSION=%%d
              set WDK_FOUND=1
              goto :found_wdk
            )
          )
          :found_wdk
          
          if %WDK_FOUND%==0 (
            echo WDK not found, continuing without driver...
            set SKIP_DRIVER=1
          ) else (
            echo Found WDK version: %WDK_VERSION%
            set WDK_INCLUDE=C:\Program Files (x86)\Windows Kits\10\Include\%WDK_VERSION%
          )
          
          REM 编译驱动（如果启用）
          if "${{ github.event.inputs.include_driver }}"=="true" (
            if "%SKIP_DRIVER%"=="" (
              echo.
              echo Building kernel driver...
              
              cl.exe /nologo /O2 /MT /W4 /Gz ^
                /I"%WDK_INCLUDE%\km" ^
                /I"%WDK_INCLUDE%\um" ^
                /I"%WDK_INCLUDE%\shared" ^
                /I"common" ^
                /D_KERNEL_MODE /DDBG=1 /DUNICODE /D_UNICODE ^
                /Feoutput\HardwareSpoofer.sys ^
                driver\HardwareSpoofer.c ^
                /link /subsystem:native ^
                ntoskrnl.lib hal.lib
              
              if errorlevel 1 (
                echo Driver build failed!
              ) else (
                echo Driver built successfully!
              )
              
              REM 编译加载器
              echo.
              echo Building driver loader...
              
              cl.exe /nologo /O2 /W4 ^
                /I"common" ^
                /Feoutput\loader.exe ^
                driver_loader\loader.c ^
                /link advapi32.lib user32.lib
              
              if errorlevel 1 (
                echo Loader build failed!
              ) else (
                echo Loader built successfully!
              )
              
              REM 编译服务
              echo.
              echo Building Windows service...
              
              cl.exe /nologo /O2 /W4 ^
                /I"common" ^
                /Feoutput\service.exe ^
                service\service.c ^
                /link advapi32.lib user32.lib
              
              if errorlevel 1 (
                echo Service build failed!
              ) else (
                echo Service built successfully!
              )
            ) else (
              echo Skipping driver build (WDK not found)
            )
          ) else (
            echo Skipping driver build (disabled by user)
          )
          
          REM 编译测试程序
          echo.
          echo Building test program...
          
          cl.exe /nologo /O2 /W4 ^
            /Feoutput\test.exe ^
            test\test.c
          
          if errorlevel 1 (
            echo Test program build failed!
          ) else (
            echo Test program built successfully!
          )
      
      # 9. 构建 GUI（如果启用）
      - name: Build GUI Application
        if: ${{ github.event.inputs.build_gui == 'true' }}
        shell: pwsh
        run: |
          echo "Building GUI application..."
          cd gui
          
          # 创建版本文件
          $version = "${{ steps.version.outputs.VERSION }}"
          @"
VERSION = '$version'
BUILD_DATE = '$(Get-Date -Format "yyyy-MM-dd HH:mm:ss")'
BUILD_PLATFORM = '${{ env.PLATFORM }}'
BUILD_TYPE = '${{ env.CONFIGURATION }}'
"@ | Out-File -FilePath version.py -Encoding utf8
          
          # 检查 PyInstaller
          if (-not (Get-Command pyinstaller -ErrorAction SilentlyContinue)) {
            pip install pyinstaller
          }
          
          # 使用 PyInstaller 打包
          pyinstaller --onefile --windowed `
            --name "HardwareMasquerade" `
            --add-data "resources;resources" `
            --hidden-import PyQt6.sip `
            --hidden-import psutil `
            --collect-all PyQt6 `
            --version-file version.txt `
            --noconfirm `
            main.py
          
          if ($LASTEXITCODE -eq 0) {
            echo "GUI built successfully!"
            # 复制到输出目录
            if (Test-Path "dist\HardwareMasquerade.exe") {
              Copy-Item -Path "dist\HardwareMasquerade.exe" -Destination "..\output\" -Force
              echo "GUI copied to output directory"
            }
          } else {
            echo "GUI build failed!"
            exit 1
          }
          
          cd ..
      
      # 10. 列出输出文件
      - name: List output files
        run: |
          echo "Output directory contents:"
          Get-ChildItem -Path output -Recurse | ForEach-Object {
            $size = [math]::Round($_.Length / 1KB, 2)
            Write-Host "  $($_.Name) ($size KB)" -ForegroundColor Yellow
          }
      
      # 11. 创建安装包（如果启用）
      - name: Create installation package
        if: ${{ github.event.inputs.create_zip == 'true' }}
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          $packageName = "HardwareMasquerade-$version-${{ env.PLATFORM }}"
          $packageDir = "artifacts\$packageName"
          
          New-Item -ItemType Directory -Force -Path $packageDir | Out-Null
          
          # 复制构建文件
          if (Test-Path "output") {
            Copy-Item -Path "output\*" -Destination $packageDir -Force -ErrorAction SilentlyContinue
          }
          
          # 创建简单的安装脚本
          @"
@echo off
title Hardware Masquerade Installer
echo ========================================
echo   Hardware Masquerade Installer v$version
echo ========================================
echo.

REM 检查管理员权限
net session >nul 2>&1
if %errorLevel% neq 0 (
    echo Requesting administrator privileges...
    powershell start-process '%~f0' -verb runas
    exit /b
)

echo Installing Hardware Masquerade...
echo.

REM 复制文件
if exist HardwareMasquerade.exe (
    echo Copying application...
    copy /Y HardwareMasquerade.exe %SystemRoot%\System32\ >nul
)

if exist HardwareSpoofer.sys (
    echo Copying driver...
    copy /Y HardwareSpoofer.sys %SystemRoot%\System32\drivers\ >nul
)

REM 创建快捷方式
powershell -Command "`$ws = New-Object -ComObject WScript.Shell; `$sc = `$ws.CreateShortcut('`$env:USERPROFILE\Desktop\HardwareMasquerade.lnk'); `$sc.TargetPath = '%SystemRoot%\System32\HardwareMasquerade.exe'; `$sc.Save()"

echo.
echo Installation complete!
echo.
pause
"@ | Out-File -FilePath "$packageDir\install.bat" -Encoding ascii -Force
          
          # 创建简单的卸载脚本
          @"
@echo off
title Hardware Masquerade Uninstaller
echo ========================================
echo   Hardware Masquerade Uninstaller
echo ========================================
echo.

REM 检查管理员权限
net session >nul 2>&1
if %errorLevel% neq 0 (
    echo Requesting administrator privileges...
    powershell start-process '%~f0' -verb runas
    exit /b
)

echo Uninstalling Hardware Masquerade...
echo.

REM 删除文件
del /F %SystemRoot%\System32\HardwareMasquerade.exe 2>nul
del /F %SystemRoot%\System32\drivers\HardwareSpoofer.sys 2>nul
del /F %USERPROFILE%\Desktop\HardwareMasquerade.lnk 2>nul

echo.
echo Uninstall complete!
echo.
pause
"@ | Out-File -FilePath "$packageDir\uninstall.bat" -Encoding ascii -Force
          
          # 创建 README
          @"
Hardware Masquerade v$version
=============================

Build Information:
- Version: $version
- Platform: ${{ env.PLATFORM }}
- Build Type: ${{ env.CONFIGURATION }}
- Build Date: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC")

Files Included:
- HardwareMasquerade.exe : Main GUI application
- HardwareSpoofer.sys    : Kernel driver (if included)
- loader.exe             : Driver loader
- service.exe            : Windows service
- test.exe               : Test program
- install.bat            : Installation script
- uninstall.bat          : Uninstallation script

Installation:
1. Right-click on install.bat and select "Run as administrator"
2. Follow the on-screen instructions
3. After installation, run HardwareMasquerade from desktop

Note: This is a manual build from GitHub Actions.
"@ | Out-File -FilePath "$packageDir\README.txt" -Encoding utf8 -Force
          
          # 创建 ZIP 包
          echo "Creating ZIP package..."
          Compress-Archive -Path "$packageDir\*" -DestinationPath "artifacts\$packageName.zip" -Force
          
          echo "Package created: artifacts\$packageName.zip"
      
      # 12. 上传构建产物
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: HardwareMasquerade-${{ steps.version.outputs.VERSION }}-${{ env.PLATFORM }}
          path: |
            output/
            artifacts/
            python-dependencies.txt
          if-no-files-found: warn
          retention-days: 30
      
      # 13. 显示构建摘要
      - name: Display build summary
        if: always()
        shell: pwsh
        run: |
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "        Build Summary" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Version:     ${{ steps.version.outputs.VERSION }}" -ForegroundColor Green
          Write-Host "Platform:    ${{ env.PLATFORM }}" -ForegroundColor Green
          Write-Host "Build Type:  ${{ env.CONFIGURATION }}" -ForegroundColor Green
          Write-Host "Driver:      ${{ github.event.inputs.include_driver }}" -ForegroundColor Green
          Write-Host "GUI:         ${{ github.event.inputs.build_gui }}" -ForegroundColor Green
          Write-Host "ZIP Package: ${{ github.event.inputs.create_zip }}" -ForegroundColor Green
          Write-Host ""
          Write-Host "Build Status: ${{ job.status }}" -ForegroundColor Green
          Write-Host ""
          Write-Host "Download artifacts from the summary page above." -ForegroundColor Yellow
